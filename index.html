<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Panel</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <style>
    .card-img-top { height: 100px; object-fit: cover; }
    .modal-img { max-width: 100%; height: auto; }
  </style>
</head>
<body class="bg-light">
  <div class="container py-4">
    <h2 class="text-center mb-4">Admin Panel</h2>

    <!-- Upload Section -->
    <div class="card mb-4">
      <div class="card-header bg-primary text-white">Upload Product</div>
      <div class="card-body">
        <div class="row g-2">
          <div class="col-md-4"><input type="text" id="image" class="form-control" placeholder="Image URL" /></div>
          <div class="col-md-2"><input type="text" id="title" class="form-control" placeholder="Title" /></div>
          <div class="col-md-2"><input type="text" id="itemCode" class="form-control" placeholder="Item Code" /></div>
          <div class="col-md-2"><input type="text" id="size" class="form-control" placeholder="Size" /></div>
          <div class="col-md-2"><input type="number" id="price" class="form-control" placeholder="Price (Ks)" /></div>
          <div class="col-12 mt-2"><textarea id="details" class="form-control" placeholder="Product Details"></textarea></div>
          <div class="col-12 mt-2"><button class="btn btn-success w-100" onclick="uploadProduct()">Upload Product</button></div>
        </div>
      </div>
    </div>

    <!-- Product Section -->
    <div class="card mb-4">
      <div class="card-header bg-secondary text-white">Product List</div>
      <div class="card-body" id="productList" style="overflow-x:auto;"></div>
    </div>

    <!-- Order Section -->
    <div class="card">
      <div class="card-header bg-warning">Order List</div>
      <div class="card-body" id="orderList" style="overflow-x:auto;"></div>
    </div>
  </div>

  <!-- Modal: Order Detail -->
  <div class="modal fade" id="orderDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header"><h5 class="modal-title">Order Details</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body" id="orderDetailBody"></div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button class="btn btn-primary" onclick="updateOrderStatus()">Update Status</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap + Script -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const scriptURL = 'https://script.google.com/macros/s/AKfycbweaRGbyHhZkvgpSl80opRnLnG9GeF93Uy4BFTzOtHgHNEC_4DHDrJ7643pSy__A2YFWA/exec'; // Replace with your Apps Script URL
    let selectedOrderId = '';

    function uploadProduct() {
      const payload = {
        action: 'uploadProduct',
        image: image.value,
        title: title.value,
        itemCode: itemCode.value,
        size: size.value,
        price: price.value,
        details: details.value
      };
      fetch(scriptURL, {
        method: 'POST',
        body: JSON.stringify(payload)
      }).then(r => r.json()).then(() => {
        alert("Product Uploaded!");
        image.value = title.value = itemCode.value = size.value = price.value = details.value = '';
        loadProducts();
      });
    }

    function loadProducts() {
      fetch(scriptURL + '?action=getProducts')
        .then(res => res.json())
        .then(data => {
          const html = data.map((p, i) => `
            <div class="card mb-2 p-2">
              <div class="row g-2 align-items-center">
                <div class="col-md-1"><img src="${p.image}" class="img-fluid rounded" /></div>
                <div class="col-md-2">${p.title}</div>
                <div class="col-md-1">${p.itemCode}</div>
                <div class="col-md-1">${p.size}</div>
                <div class="col-md-2"><input class="form-control" value="${p.price}" onchange="updateProduct('${p.itemCode}', 'price', this.value)" /></div>
                <div class="col-md-2"><input class="form-control" value="${p.stock}" onchange="updateProduct('${p.itemCode}', 'stock', this.value)" /></div>
                <div class="col-md-3"><textarea class="form-control" onchange="updateProduct('${p.itemCode}', 'details', this.value)">${p.details}</textarea></div>
              </div>
            </div>
          `).join('');
          productList.innerHTML = html;
        });
    }

    function updateProduct(itemCode, field, value) {
      fetch(scriptURL, {
        method: 'POST',
        body: JSON.stringify({ action: 'updateProduct', itemCode, field, value })
      });
    }

    function loadOrders() {
      fetch(scriptURL + '?action=getOrders')
        .then(res => res.json())
        .then(data => {
          const html = data.map(o => `
            <div class="row border-bottom py-2 align-items-center">
              <div class="col-md-2">${o.orderId}</div>
              <div class="col-md-2">${o.title}</div>
              <div class="col-md-1">${o.itemCode}</div>
              <div class="col-md-2">${o.name}</div>
              <div class="col-md-2">${o.phone}</div>
              <div class="col-md-3">
                <button class="btn btn-sm btn-info" onclick='viewOrderDetail(${JSON.stringify(o)})'>View Details</button>
              </div>
            </div>
          `).join('');
          orderList.innerHTML = html;
        });
    }

    function viewOrderDetail(order) {
      selectedOrderId = order.orderId;
      orderDetailBody.innerHTML = `
        <div class="card p-3">
          <p><strong>Order ID:</strong> ${order.orderId}</p>
          <p><strong>Title:</strong> ${order.title}</p>
          <p><strong>Item Code:</strong> ${order.itemCode}</p>
          <p><strong>Size:</strong> ${order.size}</p>
          <p><strong>Total:</strong> ${order.total}</p>
          <p><strong>Name:</strong> ${order.name}</p>
          <p><strong>Phone:</strong> ${order.phone}</p>
          <p><strong>Email:</strong> ${order.email}</p>
          <p><strong>Address:</strong> ${order.address}</p>
          <label for="orderStatus"><strong>Order Status:</strong></label>
          <select class="form-select" id="orderStatus">
            <option ${order.status === 'Order Pending' ? 'selected' : ''}>Order Pending</option>
            <option ${order.status === 'Order Accepted' ? 'selected' : ''}>Order Accepted</option>
            <option ${order.status === 'Reach at Delivery' ? 'selected' : ''}>Reach at Delivery</option>
            <option ${order.status === 'Complete' ? 'selected' : ''}>Complete</option>
          </select>
        </div>
      `;
      new bootstrap.Modal(document.getElementById('orderDetailModal')).show();
    }

    function updateOrderStatus() {
      const status = document.getElementById("orderStatus").value;
      fetch(scriptURL, {
        method: 'POST',
        body: JSON.stringify({ action: 'updateOrderStatus', orderId: selectedOrderId, status })
      }).then(() => {
        alert("Order status updated");
        loadOrders();
      });
    }

    // Auto refresh every 15 seconds
    setInterval(() => {
      loadProducts();
      loadOrders();
    }, 15000);

    window.onload = () => {
      loadProducts();
      loadOrders();
    };
  </script>
</body>
</html>
