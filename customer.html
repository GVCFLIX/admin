<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Customer Page</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <style>
    .product-img { height: 150px; object-fit: cover; cursor: pointer; }
    .cart-count { position: absolute; top: 0; right: 0; background: red; color: white; border-radius: 50%; font-size: 12px; padding: 2px 6px; }
    .fullscreen-img { max-width: 100%; height: auto; }
  </style>
</head>
<body class="bg-light">
  <div class="container py-4">
    <h2 class="text-center mb-4">Product Shop</h2>

    <!-- Cart Button -->
    <div class="text-end mb-3 position-relative">
      <button class="btn btn-dark" data-bs-toggle="modal" data-bs-target="#cartModal">
        <i class="fas fa-shopping-cart"></i> Cart <span class="cart-count" id="cartCount">0</span>
      </button>
    </div>

    <!-- Product List -->
    <div class="row" id="productContainer"></div>
  </div>

  <!-- Full Image Modal -->
  <div class="modal fade" id="imageModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-body text-center"><img id="fullImage" class="fullscreen-img" /></div>
        <div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal">Close</button></div>
      </div>
    </div>
  </div>

  <!-- Cart Modal -->
  <div class="modal fade" id="cartModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header"><h5 class="modal-title">Your Cart</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body" id="cartItems"></div>
        <div class="modal-footer">
          <button class="btn btn-primary" data-bs-target="#checkoutModal" data-bs-toggle="modal" data-bs-dismiss="modal">Check Out</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Checkout Modal -->
  <div class="modal fade" id="checkoutModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header"><h5 class="modal-title">Checkout</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
          <div class="row g-2">
            <div class="col-md-6"><input type="text" class="form-control" id="custName" placeholder="Name" /></div>
            <div class="col-md-6"><input type="text" class="form-control" id="custPhone" placeholder="Phone" onblur="checkDiscount()" /></div>
            <div class="col-md-6"><input type="email" class="form-control" id="custEmail" placeholder="Email" /></div>
            <div class="col-md-6"><input type="text" class="form-control" id="custAddress" placeholder="Address" /></div>
          </div>
          <hr/>
          <div id="orderSummary" class="text-end mt-2"></div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-success" onclick="placeOrder()">Confirm & Place Order</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const scriptURL = 'https://script.google.com/macros/s/AKfycbweaRGbyHhZkvgpSl80opRnLnG9GeF93Uy4BFTzOtHgHNEC_4DHDrJ7643pSy__A2YFWA/exec'; // Replace with your Apps Script URL
    let cart = JSON.parse(localStorage.getItem('cart') || '[]');
    let discountAmount = 0;

    function updateCartCount() {
      document.getElementById("cartCount").innerText = cart.length;
    }

    function loadProducts() {
      fetch(scriptURL + '?action=getProducts')
        .then(res => res.json())
        .then(data => {
          const html = data.map(p => `
            <div class="col-md-4 mb-4">
              <div class="card">
                <img src="${p.image}" class="card-img-top product-img" onclick="viewImage('${p.image}')" />
                <div class="card-body">
                  <h5 class="card-title">${p.title}</h5>
                  <p class="card-text">${p.details || ''}</p>
                  <p class="text-muted">Ks ${p.price}</p>
                  <button class="btn btn-sm btn-outline-primary w-100" onclick='addToCart(${JSON.stringify(p)})'>
                    <i class="fas fa-cart-plus"></i> Add to Cart
                  </button>
                </div>
              </div>
            </div>
          `).join('');
          document.getElementById("productContainer").innerHTML = html;
        });
    }

    function viewImage(url) {
      document.getElementById("fullImage").src = url;
      new bootstrap.Modal(document.getElementById("imageModal")).show();
    }

    function addToCart(product) {
      const key = product.itemCode + '-' + product.size;
      const existing = cart.find(item => item.itemCode + '-' + item.size === key);
      if (!existing) cart.push(product);
      localStorage.setItem('cart', JSON.stringify(cart));
      updateCartCount();
    }

    function renderCart() {
      const html = cart.map((item, i) => `
        <div class="d-flex justify-content-between border-bottom py-2">
          <div>${item.title} (${item.size})</div>
          <div>Ks ${item.price}</div>
          <button class="btn btn-sm btn-danger" onclick="removeFromCart(${i})"><i class="fas fa-trash"></i></button>
        </div>
      `).join('');
      document.getElementById("cartItems").innerHTML = html || "Cart is empty.";
      showOrderSummary();
    }

    function removeFromCart(index) {
      cart.splice(index, 1);
      localStorage.setItem('cart', JSON.stringify(cart));
      updateCartCount();
      renderCart();
    }

    function showOrderSummary() {
      const subtotal = cart.reduce((sum, item) => sum + Number(item.price), 0);
      const discount = discountAmount;
      const total = subtotal - discount;
      document.getElementById("orderSummary").innerHTML = `
        <p>Subtotal: Ks ${subtotal}</p>
        <p>Discount: Ks ${discount}</p>
        <h5>Total: Ks ${total}</h5>
      `;
    }

    function checkDiscount() {
      const phone = document.getElementById("custPhone").value;
      fetch(scriptURL + `?action=checkDiscount&phone=${phone}`)
        .then(res => res.json())
        .then(data => {
          discountAmount = Number(data.discount || 0);
          showOrderSummary();
        });
    }

    function placeOrder() {
      const name = custName.value.trim();
      const phone = custPhone.value.trim();
      const email = custEmail.value.trim();
      const address = custAddress.value.trim();
      if (!name || !phone || !address || cart.length === 0) {
        alert("Please fill all fields and make sure cart is not empty.");
        return;
      }

      const orderId = "ORD-" + Math.floor(10000000 + Math.random() * 90000000);
      const subtotal = cart.reduce((sum, item) => sum + Number(item.price), 0);
      const total = subtotal - discountAmount;

      const payload = {
        action: "placeOrder",
        orderId,
        name,
        phone,
        email,
        address,
        items: cart,
        discount: discountAmount,
        total
      };

      fetch(scriptURL, {
        method: 'POST',
        body: JSON.stringify(payload)
      })
      .then(res => res.json())
      .then(() => {
        alert("Order placed successfully!");
        cart = [];
        localStorage.removeItem('cart');
        updateCartCount();
        renderCart();
        document.getElementById("checkoutModal").querySelector("button.btn-close").click();
      });
    }

    setInterval(loadProducts, 15000);
    window.onload = () => {
      loadProducts();
      renderCart();
      updateCartCount();
    };
  </script>
</body>
</html>
