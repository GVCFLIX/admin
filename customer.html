<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Customer Shop</title>
  <style>
    body { font-family: sans-serif; margin: 20px; }
    .products { display: flex; flex-wrap: wrap; gap: 20px; }
    .card { border: 1px solid #ccc; padding: 10px; width: 200px; position: relative; }
    .card img { width: 100%; cursor: pointer; }
    .cart-noti { position: fixed; top: 20px; right: 20px; background: red; color: white; border-radius: 50%; padding: 10px 15px; }
    #modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: none; align-items: center; justify-content: center; }
    #modal img { max-width: 90%; max-height: 90%; }
    #checkoutModal { display: none; background: #fff; padding: 20px; position: fixed; top: 10%; left: 50%; transform: translateX(-50%); border: 1px solid #ccc; max-width: 500px; width: 100%; }
    .closeBtn { position: absolute; top: 10px; right: 10px; cursor: pointer; font-weight: bold; }
  </style>
</head>
<body>

<h1>Product Shop</h1>
<div class="cart-noti" id="cartCount" onclick="openCheckout()">ðŸ›’ 0</div>

<div class="products" id="productContainer"></div>

<!-- Image Modal -->
<div id="modal" onclick="closeModal()">
  <img id="modalImg" />
</div>

<!-- Checkout Modal -->
<div id="checkoutModal">
  <div class="closeBtn" onclick="closeCheckout()">âœ–</div>
  <h3>Checkout</h3>
  <div id="checkoutItems"></div>
  <input type="text" id="custName" placeholder="Your Name">
  <input type="text" id="custPhone" placeholder="Phone">
  <input type="text" id="custAddress" placeholder="Address">
  <input type="email" id="custEmail" placeholder="Email">
  <div id="amountSummary"></div>
  <button onclick="submitOrder()">Confirm Order</button>
</div>

<script>
const BASE_URL = "https://script.google.com/macros/s/AKfycbweaRGbyHhZkvgpSl80opRnLnG9GeF93Uy4BFTzOtHgHNEC_4DHDrJ7643pSy__A2YFWA/exec"; // replace with Apps Script URL
let cart = [];

function fetchProducts() {
  fetch(`${BASE_URL}?action=getProducts`)
    .then(res => res.json())
    .then(data => {
      let html = '';
      data.forEach(item => {
        html += `<div class="card">
          <img src="${item['Image URL']}" onclick="showImage('${item['Image URL']}')">
          <h4>${item.Title}</h4>
          <p>${item.Size}</p>
          <p>${item['Price (Ks)']} Ks</p>
          <button onclick="addToCart(${JSON.stringify(item)})">Add to Cart</button>
        </div>`;
      });
      document.getElementById("productContainer").innerHTML = html;
    });
}

function showImage(url) {
  document.getElementById("modalImg").src = url;
  document.getElementById("modal").style.display = "flex";
}

function closeModal() {
  document.getElementById("modal").style.display = "none";
}

function addToCart(item) {
  cart.push(item);
  document.getElementById("cartCount").innerText = `ðŸ›’ ${cart.length}`;
}

function openCheckout() {
  if (cart.length === 0) return alert("Cart is empty!");
  let itemsHTML = cart.map(c => `<p>${c.Title} (${c.Size}) - ${c['Price (Ks)']} Ks</p>`).join("");
  const total = cart.reduce((sum, i) => sum + parseFloat(i['Price (Ks)']), 0);
  const discount = total >= 50000 ? total * 0.1 : 0;
  const final = total - discount;

  document.getElementById("checkoutItems").innerHTML = itemsHTML;
  document.getElementById("amountSummary").innerHTML = `
    <p>Subtotal: ${total} Ks</p>
    <p>Discount: ${discount} Ks</p>
    <p><strong>Total: ${final} Ks</strong></p>
  `;
  document.getElementById("checkoutModal").style.display = "block";
}

function closeCheckout() {
  document.getElementById("checkoutModal").style.display = "none";
}

function submitOrder() {
  const name = document.getElementById("custName").value;
  const phone = document.getElementById("custPhone").value;
  const address = document.getElementById("custAddress").value;
  const email = document.getElementById("custEmail").value;
  if (!name || !phone || !address || !email) return alert("Fill all fields");

  const total = cart.reduce((sum, i) => sum + parseFloat(i['Price (Ks)']), 0);
  const discount = total >= 50000 ? total * 0.1 : 0;
  const final = total - discount;

  const product = cart[0]; // Assuming single item for demo; can modify to loop over items
  const order = {
    title: product.Title,
    itemCode: product['Item Code'],
    size: product.Size,
    totalAmount: final,
    name,
    phone,
    email,
    address
  };

  fetch(`${BASE_URL}?action=submitOrder`, {
    method: 'POST',
    body: JSON.stringify(order),
    headers: { 'Content-Type': 'application/json' }
  }).then(res => res.text())
    .then(id => {
      alert(`Order Submitted! Your Order ID: ${id}`);
      cart = [];
      document.getElementById("cartCount").innerText = "ðŸ›’ 0";
      closeCheckout();
    });
}

// Auto refresh
setInterval(fetchProducts, 15000);
fetchProducts();
</script>
</body>
</html>
